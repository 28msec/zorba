CMAKE_MINIMUM_REQUIRED(VERSION 2.6)
PROJECT(libiconv)

ADD_DEFINITIONS(-DLIBICONV_PLUG -DBUILDING_LIBICONV -DBUILDING_LIBCHARSET)
SET(PATCH_COMMAND @PATCH_COMMAND@)

CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/libcharset/config.h.in ${CMAKE_CURRENT_SOURCE_DIR}/libcharset/config.h COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/libcharset/include/localcharset.h.build.in ${CMAKE_CURRENT_SOURCE_DIR}/libcharset/include/localcharset.h COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/include/iconv.h.build.in ${CMAKE_CURRENT_SOURCE_DIR}/include/iconv.h COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/config.h.in ${CMAKE_CURRENT_SOURCE_DIR}/config.h COPYONLY)

EXECUTE_PROCESS(  COMMAND ${PATCH_COMMAND} config.h config.h.patch -R WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}  )
EXECUTE_PROCESS(  COMMAND ${PATCH_COMMAND} lib/iconv.c iconv.c.patch  -R  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}  )
EXECUTE_PROCESS(  COMMAND ${PATCH_COMMAND} include/iconv.h iconv.h.patch -R  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}  )
EXECUTE_PROCESS(  COMMAND ${PATCH_COMMAND} windows/libiconv.rc  libiconv.rc.patch -R WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}  )
EXECUTE_PROCESS(  COMMAND ${PATCH_COMMAND} libcharset/lib/localcharset.c localcharset.c.patch -R WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}  )
EXECUTE_PROCESS(  COMMAND ${PATCH_COMMAND} libcharset/include/localcharset.h localcharset.h.patch -R WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}  )

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/libcharset)
INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/libcharset/include)
INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/include)
INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/lib)


ADD_LIBRARY(iconv SHARED lib/iconv.c lib/relocatable.c libcharset/lib/localcharset.c windows/libiconv.rc)

INSTALL(TARGETS iconv DESTINATION bin )
INSTALL(TARGETS iconv DESTINATION lib )
INSTALL(FILES ${CMAKE_CURRENT_SOURCE_DIR}/libcharset/include/localcharset.h DESTINATION include)
INSTALL(FILES ${CMAKE_CURRENT_SOURCE_DIR}/include/iconv.h DESTINATION include)

