<div class="doxygen">
  <div><h1 class="title">Web Crawler example in XQuery</h1>
Description of a web crawler example in XQuery.<br/>
 Entire script can be seen here: <a href="/pages/3.0/zorba/link_crawler2">web crawler script </a><br/>
 The idea is to crawl through the pages of a website and store a list with external pages and internal pages and check if they work or not. This example uses Zorba's http module for accessing the webpages, and the html module for converting the html to xml. The complete code can be found in the test directory of the html convertor module (link_crawler2.xq2).<pre class="ace-static" ace-mode="xquery"><span class="keyword">import</span><span class="normal"><span> </span>module<span> </span></span><span class="keyword">namespace<span> </span></span><span class="normal">http<span> </span>=<span> </span></span><span class="stringliteral">"http://www.zorba-xquery.com/modules/http-client"</span><span class="normal">;</span>
<span class="normal"/><span class="keyword">import</span><span class="normal"><span> </span>module<span> </span></span><span class="keyword">namespace<span> </span></span><span class="normal">map<span> </span>=<span> </span></span><span class="stringliteral">"http://zorba.io/modules/store/data-structures/unordered-map"</span><span class="normal">;</span>
<span class="normal"/><span class="keyword">import</span><span class="normal"><span> </span>module<span> </span></span><span class="keyword">namespace<span> </span></span><span class="normal">html<span> </span>=<span> </span></span><span class="stringliteral">"http://www.zorba-xquery.com/modules/converters/html"</span><span class="normal">;</span>
<span class="normal"/><span class="keyword">import</span><span class="normal"><span> </span>module<span> </span></span><span class="keyword">namespace<span> </span></span><span class="normal">parse-xml<span> </span>=<span> </span></span><span class="stringliteral">"http://www.zorba-xquery.com/modules/xml"</span><span class="normal">;</span>
<span class="normal"/><span class="keyword">import</span><span class="normal"><span> </span>module<span> </span></span><span class="keyword">namespace<span> </span></span><span class="normal"><a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22ad51f6a8152afdfbcf0e0dd0d1c86cee0">file</a><span> </span>=<span> </span></span><span class="stringliteral">"http://expath.org/ns/file"</span><span class="normal">;</span>
</pre>The internal pages are checked recursively, while the external ones are only checked for existence. The distinction between internal and external links is made by comparing the URI with a global string variable $uri-host. Change this variable to point to your website, or a subdirectory on your website.<pre class="ace-static" ace-mode="xquery"><span class="normal">declare<span> </span>variable<span> </span>$top-uri<span> </span><span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal"><span> </span>:=<span> </span></span><span class="stringliteral">"http://zorba.io/"</span><span class="normal">;</span>
<span class="normal">declare<span> </span>variable<span> </span>$uri-host<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal"><span> </span>:=<span> </span></span><span class="stringliteral">"http://zorba.io"</span><span class="normal">;</span>
<span class="normal"/>
<span class="normal">declare<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7">is</a>-</span><span class="keyword">internal</span><span class="normal">($x<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:string)<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">boolean</span><span class="normal"/>
<span class="normal">{</span>
<span class="normal"><span> </span>starts-with($x,<span> </span>$uri-host)</span>
<span class="normal">};</span>
</pre>The crawling starts from the URI pointed by $top-uri.Visited links are stored as nodes in two maps, one for internal pages and one for external pages. The keys are the URIs, and the values are the strings "broken" or "clean", plus error codes if processing failed. The maps are used to avoid parsing the same page twice.<pre class="ace-static" ace-mode="xquery"><span class="normal">declare<span> </span>variable<span> </span>$local:processed-</span><span class="keyword">internal</span><span class="normal">-links<span> </span>:=<span> </span>xs:QName(</span><span class="stringliteral">"processed-internal-links"</span><span class="normal">);</span>
<span class="normal">declare<span> </span>variable<span> </span>$local:processed-external-links<span> </span>:=<span> </span>xs:QName(</span><span class="stringliteral">"processed-external-links"</span><span class="normal">);</span>
<span class="normal"/>
<span class="normal">declare<span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:create-containers()</span>
<span class="normal">{</span>
<span class="normal"><span> </span><span> </span>map:create($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>xs:QName(</span><span class="stringliteral">"xs:string"</span><span class="normal">));</span>
<span class="normal"><span> </span><span> </span>map:create($local:processed-external-links,<span> </span>xs:QName(</span><span class="stringliteral">"xs:string"</span><span class="normal">));</span>
<span class="normal">};</span>
<span class="normal"/>
<span class="normal">declare<span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:</span><span class="keyword">delete</span><span class="normal">-containers(){</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">for</span><span class="normal"><span> </span>$x<span> </span>in<span> </span>map:available-maps()</span>
<span class="normal"><span> </span><span> </span>return<span> </span>map:delete($x);</span>
<span class="normal">};</span>
</pre>After parsing an internal page with html module, all the links are extracted and parsed recursively, if they haven't been parsed. The html module uses tidy library, so we use tidy options to setup for converting from html to xml. Some html tags are marked to be ignored in new-inline-tags param, this being a particular case of this website. You can add or remove tags to suit your website needs.<br/>
 The spaces in the url links are trimmed and normalized, and the fragment part is ignored.<pre class="ace-static" ace-mode="xquery"><span class="normal">declare<span> </span>variable<span> </span>$local:tidy-options<span> </span>:=<span> </span>&lt;options<span> </span>xmlns=</span><span class="stringliteral">"http://www.zorba-xquery.com/modules/converters/html-options"</span><span class="normal"><span> </span>&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"output-xml"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"yes"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"doctype"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"omit"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"quote-nbsp"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"no"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"char-encoding"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"utf8"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"newline"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"LF"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"tidy-mark"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"no"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;tidyParam<span> </span>name=</span><span class="stringliteral">"new-inline-tags"</span><span class="normal"><span> </span>value=</span><span class="stringliteral">"nav<span> </span>header<span> </span>section<span> </span>article<span> </span>footer<span> </span>xqdoc:custom<span> </span>d<span> </span>c<span> </span>options<span> </span>json-param"</span><span class="normal"><span> </span>/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;/options&gt;;</span>
<span class="normal"/>
<span class="normal">declare<span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:</span><span class="keyword">get</span><span class="normal">-real-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($href<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">,<span> </span>$start-uri<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">)<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">?</span>
<span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span>variable<span> </span>$absuri;</span>
<span class="normal"><span> </span><span> </span><span> </span></span><span class="keywordflow">try</span><span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span>$absuri<span> </span>:=<span> </span>local:<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781acc7c1f0e7924f696fa18d2bacdd1d092">my</a>-substring-before(resolve-uri(fn:normalize-space($href),<span> </span>$start-uri),<span> </span></span><span class="stringliteral">"#"</span><span class="normal">);</span>
<span class="normal"><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span></span><span class="keywordflow">catch</span><span class="normal"><span> </span>*</span>
<span class="normal"><span> </span><span> </span><span> </span>{<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span>map:insert($local:processed-external-links,<span> </span>(&lt;FROM&gt;{$start-uri}&lt;/FROM&gt;,<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;MESSAGE&gt;malformed&lt;/MESSAGE&gt;,</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;RESULT&gt;broken&lt;/RESULT&gt;),<span> </span>$href);</span>
<span class="normal"><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span>$absuri</span>
<span class="normal">};</span>
<span class="normal"/>
<span class="normal">declare<span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:</span><span class="keyword">get</span><span class="normal">-out-links-parsed($content<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>node()*,<span> </span>$uri<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">)<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">*</span>
<span class="normal">{<span> </span><span> </span>distinct-values(<span> </span></span><span class="keywordflow">for</span><span class="normal"><span> </span>$y<span> </span>in<span> </span><span> </span>($content</span><span class="comment">//*:a/string(@href),</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$content</span><span class="comment">//*:link/string(@href),</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$content</span><span class="comment">//*:script/string(@src),</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$content</span><span class="comment">//*:img/string(@src),</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$content</span><span class="comment">//*:area/string(@href)</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>)</span>
<span class="normal"/><span class="keywordflow">return</span><span class="normal"><span> </span><span> </span>local:</span><span class="keyword">get</span><span class="normal">-real-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($y,<span> </span>$uri))</span>
<span class="normal">};</span>
<span class="normal"/>
<span class="normal"/>
<span class="normal">declare<span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:map-insert-result($map-name<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:QName,<span> </span>$url<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">,<span> </span>$http-result<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>item()*)<span> </span></span>
<span class="normal">{</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(count($http-result)<span> </span>ge<span> </span>1)<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span>then<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>map:insert($map-name,<span> </span>(&lt;STATUS&gt;{fn:string($http-result[1]/@status)}&lt;/STATUS&gt;,</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;MESSAGE&gt;{fn:string($http-result[1]/@message)}&lt;/MESSAGE&gt;,</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;RESULT&gt;{</span><span class="keywordflow">if</span><span class="normal">(local:alive($http-result))<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span></span><span class="stringliteral">"Ok"</span><span class="normal"><span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span></span><span class="keywordflow">if</span><span class="normal">(local:<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7">is</a>-redirect($http-result))</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span></span><span class="stringliteral">"redirect"</span><span class="normal"><span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span></span><span class="stringliteral">"broken"</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}&lt;/RESULT&gt;),<span> </span>$url);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>map:insert($map-name,<span> </span>&lt;RESULT&gt;broken&lt;/RESULT&gt;,<span> </span>$url);</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(local:<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7">is</a>-redirect($http-result))<span> </span>then</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span>map:insert($map-name,<span> </span>&lt;REDIRECT&gt;{fn:string($http-result[1]/httpsch:header[@name<span> </span>=<span> </span></span><span class="stringliteral">"Location"</span><span class="normal">]/@value)}&lt;/REDIRECT&gt;,<span> </span>$url);</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}</span>
<span class="normal">};</span>
<span class="normal"/>
<span class="normal">declare<span> </span><span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:process-</span><span class="keyword">internal</span><span class="normal">-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($x<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">,<span> </span>$baseUri<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">,<span> </span>$n<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:integer){</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(not(empty(map:</span><span class="keyword">get</span><span class="normal">($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>$x))))</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span>exit<span> </span>returning<span> </span></span><span class="keyword">false</span><span class="normal">();</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>fn:trace($x,<span> </span></span><span class="stringliteral">"GET<span> </span>internal<span> </span>link"</span><span class="normal">);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>map:insert($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>&lt;FROM&gt;{$baseUri}&lt;/FROM&gt;,<span> </span>$x);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>variable<span> </span>$http-call:=();</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">try</span><span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$http-call:=http:send-request(&lt;httpsch:request<span> </span>method=</span><span class="stringliteral">"GET"</span><span class="normal"><span> </span>href=</span><span class="stringliteral">"{$x}"</span><span class="normal"><span> </span>follow-redirect=</span><span class="stringliteral">"false"</span><span class="normal">/&gt;,<span> </span>(),<span> </span>());</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">catch</span><span class="normal"><span> </span>*<span> </span>{<span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(local:<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7">is</a>-redirect($http-call))<span> </span>then</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>local:map-insert-result($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>$x,<span> </span>$http-call);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">try</span><span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$http-call:=http:send-request(&lt;httpsch:request<span> </span>method=</span><span class="stringliteral">"GET"</span><span class="normal"><span> </span>href=</span><span class="stringliteral">"{$x}"</span><span class="normal">/&gt;,<span> </span>(),<span> </span>());</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">catch</span><span class="normal"><span> </span>*<span> </span>{<span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(<span> </span>not(local:alive($http-call)))</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span>{<span> </span>local:map-insert-result($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>$x,<span> </span>$http-call);<span> </span>exit<span> </span>returning<span> </span>();}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(not<span> </span>(local:</span><span class="keyword">get</span><span class="normal">-media-<a href="/pages/3.0/zorba/namespacezorba_1_1time_1_1calendar?anchor=a7c8c84a1ed5401ddae49da3f01861c87">type</a>($http-call[1])<span> </span>=<span> </span></span><span class="stringliteral">"text/html"</span><span class="normal">))</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span>{<span> </span>local:map-insert-result($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>$x,<span> </span>$http-call);<span> </span>exit<span> </span>returning<span> </span>();}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>variable<span> </span>$string-content<span> </span>:=<span> </span>string($http-call[2]);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>variable<span> </span>$content:=();</span>
<span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">try</span><span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$content:=html:parse($string-content,$local:tidy-options<span> </span>);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>local:map-insert-result($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>$x,<span> </span>$http-call);<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">catch</span><span class="normal"><span> </span>*</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>{<span> </span><span> </span><span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>map:insert($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>(&lt;MESSAGE&gt;{concat(</span><span class="stringliteral">"cannot<span> </span>tidy:<span> </span>"</span><span class="normal">,<span> </span>$err:description)}&lt;/MESSAGE&gt;,</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;RESULT&gt;broken&lt;/RESULT&gt;),<span> </span>$x);<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">try</span><span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$content:=parse-xml:parse-xml-fragment<span> </span>($string-content,<span> </span></span><span class="stringliteral">""</span><span class="normal">);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">catch</span><span class="normal"><span> </span>*</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>{<span> </span>map:insert($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,<span> </span>&lt;MESSAGE&gt;{concat(</span><span class="stringliteral">"cannot<span> </span>parse:<span> </span>"</span><span class="normal">,<span> </span>$err:description)}&lt;/MESSAGE&gt;,<span> </span>$x);}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>variable<span> </span>$links<span> </span>:=();</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(empty($content))</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span>$links:=local:</span><span class="keyword">get</span><span class="normal">-out-links-unparsed($string-content,<span> </span>fn:trace($x,<span> </span></span><span class="stringliteral">"parse<span> </span>with<span> </span>regex,<span> </span>because<span> </span>tidy<span> </span>failed"</span><span class="normal">));</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>$links:=local:</span><span class="keyword">get</span><span class="normal">-out-links-parsed($content,<span> </span>$x);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">for</span><span class="normal"><span> </span>$l<span> </span>in<span> </span>$links</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">return</span><span class="normal"><span> </span><span> </span>local:process-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($l,<span> </span>$x,<span> </span>$n+1);</span>
<span class="normal">};</span>
</pre>For each parsed link, we store the FROM, STATUS, MESSAGE and RESULT. The RESULT is "Ok" if everything went fine, or "broken" if the page couldn't be retrieved or passed, and in this case MESSAGE contains the error message. The FROM element contains the parent url for that link.<br/>
 <br/>
 Some html pages have errors, and tidy library is very strict with checking errors. When the parsing fails, we fallback to using regex for extracting the links.<pre class="ace-static" ace-mode="xquery"><span class="normal">declare<span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:</span><span class="keyword">get</span><span class="normal">-out-links-unparsed($content<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">,<span> </span>$uri<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">)<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">*{</span>
<span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>distinct-values(<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>let<span> </span>$search<span> </span>:=<span> </span>fn:analyze-</span><span class="keywordtype">string</span><span class="normal">($content,<span> </span></span><span class="stringliteral">"(&amp;lt;|&amp;amp;lt;|&lt;)(((a|link|area).+?href)|((script|img).+?src))=(["</span><span class="stringliteral">"'])(.*?)\7"</span><span class="normal">)</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">for</span><span class="normal"><span> </span>$other-uri2<span> </span>in<span> </span><span> </span>$search</span><span class="comment">//group[@nr=8]/string()</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">return</span><span class="normal"><span> </span>local:</span><span class="keyword">get</span><span class="normal">-real-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($other-uri2,<span> </span>$uri)</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span>)</span>
<span class="normal">};</span>
</pre>For external links, we just check if they exist, so the http command requests only for HEAD. Some websites return error for HEAD, in this case we revert to use GET.<pre class="ace-static" ace-mode="xquery"><span class="normal">declare<span> </span><span> </span>%<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c">an</a>:sequential<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:process-external-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($x<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">,<span> </span>$baseUri<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>xs:</span><span class="keywordtype">string</span><span class="normal">){</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(not(empty(map:</span><span class="keyword">get</span><span class="normal">($local:processed-external-links,<span> </span>$x))))</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>then<span> </span><span> </span><span> </span>exit<span> </span>returning<span> </span></span><span class="keyword">false</span><span class="normal">();</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}</span>
<span class="normal"><span> </span><span> </span>fn:trace($x,<span> </span></span><span class="stringliteral">"HEAD<span> </span>external<span> </span>link"</span><span class="normal">);</span>
<span class="normal"><span> </span><span> </span>map:insert($local:processed-external-links,<span> </span>&lt;FROM&gt;{$baseUri}&lt;/FROM&gt;,<span> </span>$x);</span>
<span class="normal"><span> </span><span> </span>variable<span> </span>$http-call:=();</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">try</span><span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$http-call:=http:send-request(&lt;httpsch:request<span> </span>method=</span><span class="stringliteral">"GET"</span><span class="normal"><span> </span>href=</span><span class="stringliteral">"{$x}"</span><span class="normal">/&gt;,<span> </span>(),<span> </span>());</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">((count($http-call)<span> </span>ge<span> </span>1)<span> </span>and<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>fn:not($http-call[1]/@status<span> </span>eq<span> </span>200))<span> </span>then</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">if</span><span class="normal">(local:<a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7">is</a>-redirect($http-call))<span> </span>then</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>local:map-insert-result($local:processed-external-links,<span> </span>$x,<span> </span>$http-call);</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"><span> </span>{}<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>$http-call:=http:send-request(&lt;httpsch:request<span> </span>method=</span><span class="stringliteral">"GET"</span><span class="normal"><span> </span>href=</span><span class="stringliteral">"{$x}"</span><span class="normal">/&gt;,<span> </span>(),<span> </span>());</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>local:map-insert-result($local:processed-external-links,<span> </span>$x,<span> </span>$http-call);<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">else</span><span class="normal"/>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>{}</span>
<span class="normal"><span> </span><span> </span>}</span>
<span class="normal"><span> </span><span> </span></span><span class="keywordflow">catch</span><span class="normal"><span> </span>*<span> </span></span>
<span class="normal"><span> </span><span> </span>{<span> </span>$http-call:=();}</span>
<span class="normal"><span> </span><span> </span>local:map-insert-result($local:processed-external-links,<span> </span>$x,<span> </span>$http-call);<span> </span></span>
<span class="normal">};</span>
</pre>After parsing, the results are returned in xml format.<pre class="ace-static" ace-mode="xquery"><span class="normal">declare<span> </span></span><span class="keyword">function</span><span class="normal"><span> </span>local:print-results()<span> </span><a href="/pages/3.0/zorba/namespacezorba_1_1locale_1_1iso639__1?anchor=aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0">as</a><span> </span>element()*</span>
<span class="normal">{</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">for</span><span class="normal"><span> </span>$x<span> </span>in<span> </span>map:keys($local:processed-</span><span class="keyword">internal</span><span class="normal">-links)/map:attribute/@value/string()</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span>return<span> </span>&lt;INTERNAL&gt;&lt;LINK&gt;{$x}&lt;/LINK&gt;&lt;RESULT&gt;{map:</span><span class="keyword">get</span><span class="normal">($local:processed-</span><span class="keyword">internal</span><span class="normal">-links,$x)}&lt;/RESULT&gt;&lt;/INTERNAL&gt;,<span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span></span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span></span><span class="keywordflow">for</span><span class="normal"><span> </span>$x<span> </span>in<span> </span>map:keys($local:processed-external-links)/map:attribute/@value/string()</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span>return<span> </span>&lt;EXTERNAL&gt;&lt;LINK&gt;{$x}&lt;/LINK&gt;&lt;RESULT&gt;{map:</span><span class="keyword">get</span><span class="normal">($local:processed-external-links,$x)}&lt;/RESULT&gt;&lt;/EXTERNAL&gt;</span>
<span class="normal">};</span>
</pre>The main program calls the recursive function local:process-link for the $top-uri.<pre class="ace-static" ace-mode="xquery"><span class="normal">(:==========================================</span>
<span class="normal">===========================================:)</span>
<span class="normal"/>
<span class="normal">variable<span> </span>$uri:=<span> </span>$top-uri;</span>
<span class="normal"/>
<span class="normal">variable<span> </span>$result;</span>
<span class="normal"/>
<span class="normal">local:create-containers();</span>
<span class="normal">local:process-<a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0">link</a>($uri,<span> </span></span><span class="stringliteral">""</span><span class="normal">,<span> </span>1);</span>
<span class="normal">$result:=local:print-results()<span> </span>;</span>
<span class="normal"/>
<span class="normal">local:</span><span class="keyword">delete</span><span class="normal">-containers();</span>
<span class="normal"/>
<span class="normal"><a href="/pages/3.0/zorba/namespacezorba_1_1fs?anchor=a33bc6a07dd3ac39c5107606fc21bea22ad51f6a8152afdfbcf0e0dd0d1c86cee0">file</a>:write(fn:resolve-uri(</span><span class="stringliteral">"link_crawler_result.xml"</span><span class="normal">),</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;result&gt;{$result}&lt;/result&gt;,</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;output:serialization-parameters&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;output:indent<span> </span>value=</span><span class="stringliteral">"yes"</span><span class="normal">/&gt;</span>
<span class="normal"><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span>&lt;/output:serialization-parameters&gt;)</span>
</pre>     </div>
</div>