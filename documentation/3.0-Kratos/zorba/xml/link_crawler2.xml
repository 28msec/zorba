<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.7.6.1">
  <compounddef id="link_crawler2" kind="page">
    <compoundname>link_crawler2</compoundname>
    <title>Web Crawler example in XQuery</title>
    <detaileddescription>
<para><programlisting><codeline><highlight class="normal">(:</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>Copyright<sp/>2006-2011<sp/>The<sp/>FLWOR<sp/>Foundation.</highlight></codeline>
<codeline><highlight class="normal"><sp/>:</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>Licensed<sp/>under<sp/>the<sp/>Apache<sp/>License,<sp/>Version<sp/>2.0<sp/>(the<sp/></highlight><highlight class="stringliteral">&quot;License&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>you<sp/>may<sp/>not<sp/>use<sp/></highlight><highlight class="keyword">this</highlight><highlight class="normal"><sp/><ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22ad51f6a8152afdfbcf0e0dd0d1c86cee0" kindref="member">file</ref><sp/>except<sp/>in<sp/>compliance<sp/>with<sp/>the<sp/>License.</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>You<sp/>may<sp/>obtain<sp/>a<sp/>copy<sp/>of<sp/>the<sp/>License<sp/>at</highlight></codeline>
<codeline><highlight class="normal"><sp/>:</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>http:</highlight><highlight class="comment">//www.apache.org/licenses/LICENSE-2.0</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/>:</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>Unless<sp/>required<sp/>by<sp/>applicable<sp/>law<sp/>or<sp/>agreed<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a0f4527a84781e2e19c9796b2b7fcacba" kindref="member" tooltip="Tonga.">to</ref><sp/>in<sp/>writing,<sp/>software</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>distributed<sp/>under<sp/>the<sp/>License<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7" kindref="member" tooltip="Icelandic.">is</ref><sp/>distributed<sp/>on<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref><sp/></highlight><highlight class="stringliteral">&quot;AS<sp/>IS&quot;</highlight><highlight class="normal"><sp/>BASIS,</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>WITHOUT<sp/>WARRANTIES<sp/>OR<sp/>CONDITIONS<sp/>OF<sp/>ANY<sp/>KIND,<sp/>either<sp/>express<sp/>or<sp/>implied.</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>See<sp/>the<sp/>License<sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>the<sp/>specific<sp/>language<sp/>governing<sp/>permissions<sp/>and</highlight></codeline>
<codeline><highlight class="normal"><sp/>:<sp/>limitations<sp/>under<sp/>the<sp/>License.</highlight></codeline>
<codeline><highlight class="normal">:)</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>module<sp/></highlight><highlight class="keyword">namespace</highlight><highlight class="normal"><sp/>http<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://www.zorba-xquery.com/modules/http-client&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>module<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">map<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://zorba.io/modules/store/data-structures/unordered-map&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>module<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">html<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://www.zorba-xquery.com/modules/converters/html&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>module<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">parse-xml<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://www.zorba-xquery.com/modules/xml&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>module<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22ad51f6a8152afdfbcf0e0dd0d1c86cee0" kindref="member">file</ref><sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://expath.org/ns/file&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref><sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://zorba.io/annotations&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">xhtml=</highlight><highlight class="stringliteral">&quot;http://www.w3.org/1999/xhtml&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">output=</highlight><highlight class="stringliteral">&quot;http://www.w3.org/2010/xslt-xquery-serialization&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">err=</highlight><highlight class="stringliteral">&quot;http://www.w3.org/2005/xqt-errors&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal">httpsch<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;http://expath.org/ns/http-client&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>variable<sp/>$top-uri<sp/><sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal"><sp/>:=<sp/></highlight><highlight class="stringliteral">&quot;http://www.zorba.io/&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal">declare<sp/>variable<sp/>$uri-host<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal"><sp/>:=<sp/></highlight><highlight class="stringliteral">&quot;http://www.zorba.io&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>variable<sp/>$local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links<sp/>:=<sp/>xs:QName(</highlight><highlight class="stringliteral">&quot;processed-internal-links&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal">declare<sp/>variable<sp/>$local:processed-external-links<sp/>:=<sp/>xs:QName(</highlight><highlight class="stringliteral">&quot;processed-external-links&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:create-containers()</highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>map:create($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>xs:QName(</highlight><highlight class="stringliteral">&quot;xs:string&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>map:create($local:processed-external-links,<sp/>xs:QName(</highlight><highlight class="stringliteral">&quot;xs:string&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:</highlight><highlight class="keyword">delete</highlight><highlight class="normal">-containers(){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>$x<sp/>in<sp/>map:available-maps()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>return<sp/>map:delete($x);</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>function<sp/>local:<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7" kindref="member" tooltip="Icelandic.">is</ref>-internal($x<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/>starts-with($x,<sp/>$uri-host)</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781acc7c1f0e7924f696fa18d2bacdd1d092" kindref="member" tooltip="Burmese.">my</ref>-substring-before($s1<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$s2<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal">let<sp/>$sb<sp/>:=<sp/>fn:substring-before($s1,<sp/>$s2)</highlight></codeline>
<codeline><highlight class="normal">return<sp/><sp/>if($sb<sp/>=<sp/>&quot;&quot;)<sp/>then<sp/><sp/>$s1<sp/>else<sp/>$sb</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/>function<sp/>local:get-real-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($href<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$start-uri<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">?</highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>variable<sp/>$absuri;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>$absuri<sp/>:=<sp/>local:<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781acc7c1f0e7924f696fa18d2bacdd1d092" kindref="member" tooltip="Burmese.">my</ref>-substring-before(resolve-uri(fn:normalize-space($href),<sp/>$start-uri),<sp/></highlight><highlight class="stringliteral">&quot;#&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>{<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>map:insert($local:processed-external-links,<sp/>(&lt;FROM&gt;{$start-uri}&lt;/FROM&gt;,<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;MESSAGE&gt;malformed&lt;/MESSAGE&gt;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;RESULT&gt;broken&lt;/RESULT&gt;),<sp/>$href);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>$absuri</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/><sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-media-<ref refid="namespacezorba_1_1time_1_1calendar_1a7c8c84a1ed5401ddae49da3f01861c87" kindref="member">type</ref><sp/>($http-call<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>node())<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>local:<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781acc7c1f0e7924f696fa18d2bacdd1d092" kindref="member" tooltip="Burmese.">my</ref>-substring-before($http-call/httpsch:header[@name<sp/>=<sp/></highlight><highlight class="stringliteral">&apos;Content-Type&apos;</highlight><highlight class="normal">][1]/</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">(@value),<sp/></highlight><highlight class="stringliteral">&quot;;&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:alive($http-call<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>item()*)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((count($http-call)<sp/>ge<sp/>1)<sp/>and<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>($http-call[1]/@status<sp/>eq<sp/>200))<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/>then<sp/></highlight><highlight class="keyword">true</highlight><highlight class="normal">()<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>fn:trace(</highlight><highlight class="keyword">false</highlight><highlight class="normal">(),<sp/></highlight><highlight class="stringliteral">&quot;alive&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-out-links-parsed($content<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>node()*,<sp/>$uri<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">*</highlight></codeline>
<codeline><highlight class="normal">{<sp/><sp/>distinct-values(<sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>$y<sp/>in<sp/><sp/>($content</highlight><highlight class="comment">//*:a/string(@href),</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$content</highlight><highlight class="comment">//*:link/string(@href),</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$content</highlight><highlight class="comment">//*:script/string(@src),</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$content</highlight><highlight class="comment">//*:img/string(@src),</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$content</highlight><highlight class="comment">//*:area/string(@href)</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline><highlight class="normal"></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><sp/>local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-real-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($y,<sp/>$uri))</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-out-links-unparsed($content<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$uri<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">*{</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>distinct-values(<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>let<sp/>$search<sp/>:=<sp/>fn:analyze-</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">($content,<sp/></highlight><highlight class="stringliteral">&quot;(&amp;lt;|&amp;amp;lt;|&lt;)(((a|link|area).+?href)|((script|img).+?src))=([&quot;</highlight><highlight class="stringliteral">&quot;&apos;])(.*?)\7&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>$other-uri2<sp/>in<sp/><sp/>$search</highlight><highlight class="comment">//group[@nr=8]/string()</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-real-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($other-uri2,<sp/>$uri)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:map-insert-result($map-name<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:QName,<sp/>$url<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$http-result<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>item()*)<sp/></highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(count($http-result)<sp/>ge<sp/>1)<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>then<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>map:insert($map-name,<sp/>(&lt;STATUS&gt;{fn:string($http-result[1]/@status)}&lt;/STATUS&gt;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;MESSAGE&gt;{fn:string($http-result[1]/@message)}&lt;/MESSAGE&gt;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;RESULT&gt;{</highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(local:alive($http-result))<sp/>then<sp/></highlight><highlight class="stringliteral">&quot;Ok&quot;</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;broken&quot;</highlight><highlight class="normal">}&lt;/RESULT&gt;),<sp/>$url)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>else<sp/>map:insert($map-name,<sp/>&lt;RESULT&gt;broken&lt;/RESULT&gt;,<sp/>$url)</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/>function<sp/>local:process-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($x<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$baseUri<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$n<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:integer)<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>item()*{</highlight></codeline>
<codeline><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(local:<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a11cc1dd79aff8b41628c4f17295d25a7" kindref="member" tooltip="Icelandic.">is</ref>-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">($x))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>then<sp/>local:process-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($x,<sp/>$baseUri,<sp/>$n);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>local:process-external-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($x,<sp/>$baseUri);</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/><sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:process-external-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($x<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$baseUri<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(not(empty(map:</highlight><highlight class="keyword">get</highlight><highlight class="normal">($local:processed-external-links,<sp/>$x))))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>then<sp/><sp/><sp/>exit<sp/>returning<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>fn:trace($x,<sp/></highlight><highlight class="stringliteral">&quot;HEAD<sp/>external<sp/>link&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>map:insert($local:processed-external-links,<sp/>&lt;FROM&gt;{$baseUri}&lt;/FROM&gt;,<sp/>$x);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>variable<sp/>$http-call:=();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$http-call:=http:send-request(&lt;httpsch:request<sp/>method=</highlight><highlight class="stringliteral">&quot;HEAD&quot;</highlight><highlight class="normal"><sp/>href=</highlight><highlight class="stringliteral">&quot;{$x}&quot;</highlight><highlight class="normal">/&gt;,<sp/>(),<sp/>());</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">((count($http-call)<sp/>ge<sp/>1)<sp/>and<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>fn:not($http-call[1]/@status<sp/>eq<sp/>200))<sp/>then</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$http-call:=http:send-request(&lt;httpsch:request<sp/>method=</highlight><highlight class="stringliteral">&quot;GET&quot;</highlight><highlight class="normal"><sp/>href=</highlight><highlight class="stringliteral">&quot;{$x}&quot;</highlight><highlight class="normal">/&gt;,<sp/>(),<sp/>());</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>*<sp/>{<sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/>local:map-insert-result($local:processed-external-links,<sp/>$x,<sp/>$http-call);<sp/></highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:tidy-options()</highlight></codeline>
<codeline><highlight class="normal">{&lt;options<sp/>xmlns=</highlight><highlight class="stringliteral">&quot;http://www.zorba-xquery.com/modules/converters/html-options&quot;</highlight><highlight class="normal"><sp/>&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;output-xml&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;yes&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;doctype&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;omit&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;quote-nbsp&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;no&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;char-encoding&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;utf8&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;newline&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;LF&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;tidy-mark&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;no&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;tidyParam<sp/>name=</highlight><highlight class="stringliteral">&quot;new-inline-tags&quot;</highlight><highlight class="normal"><sp/>value=</highlight><highlight class="stringliteral">&quot;nav<sp/>header<sp/>section<sp/>article<sp/>footer<sp/>xqdoc:custom<sp/>d<sp/>c<sp/>options<sp/>json-param&quot;</highlight><highlight class="normal"><sp/>/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;/options&gt;</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/><sp/>%<ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781abdd3c2de1222fd3167e2675969aa694c" kindref="member" tooltip="Aragonese.">an</ref>:sequential<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:process-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($x<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$baseUri<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:</highlight><highlight class="keywordtype">string</highlight><highlight class="normal">,<sp/>$n<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>xs:integer){</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>(:<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">($n=3)<sp/>then<sp/>exit<sp/>returning<sp/>();<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{}<sp/>:)</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(not(empty(map:</highlight><highlight class="keyword">get</highlight><highlight class="normal">($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>$x))))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>then<sp/>exit<sp/>returning<sp/></highlight><highlight class="keyword">false</highlight><highlight class="normal">();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>fn:trace($x,<sp/></highlight><highlight class="stringliteral">&quot;GET<sp/>internal<sp/>link&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>map:insert($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>&lt;FROM&gt;{$baseUri}&lt;/FROM&gt;,<sp/>$x);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>variable<sp/>$http-call:=();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$http-call:=http:send-request(&lt;httpsch:request<sp/>method=</highlight><highlight class="stringliteral">&quot;GET&quot;</highlight><highlight class="normal"><sp/>href=</highlight><highlight class="stringliteral">&quot;{$x}&quot;</highlight><highlight class="normal">/&gt;,<sp/>(),<sp/>());</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>*<sp/>{<sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>not(local:alive($http-call)))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>then<sp/>{<sp/>local:map-insert-result($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>$x,<sp/>$http-call);<sp/>exit<sp/>returning<sp/>();}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(not<sp/>(local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-media-<ref refid="namespacezorba_1_1time_1_1calendar_1a7c8c84a1ed5401ddae49da3f01861c87" kindref="member">type</ref>($http-call[1])<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;text/html&quot;</highlight><highlight class="normal">))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>then<sp/>{<sp/>local:map-insert-result($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>$x,<sp/>$http-call);<sp/>exit<sp/>returning<sp/>();}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>variable<sp/>$string-content<sp/>:=<sp/>string($http-call[2]);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>variable<sp/>$content:=();</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$content:=html:parse($string-content,local:tidy-options()<sp/>);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>local:map-insert-result($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>$x,<sp/>$http-call);<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{<sp/><sp/><sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>map:insert($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>(&lt;MESSAGE&gt;{concat(</highlight><highlight class="stringliteral">&quot;cannot<sp/>tidy:<sp/>&quot;</highlight><highlight class="normal">,<sp/>$err:description)}&lt;/MESSAGE&gt;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;RESULT&gt;broken&lt;/RESULT&gt;),<sp/>$x);<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>$content:=parse-xml:parse-xml-fragment<sp/>($string-content,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>*</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{<sp/>map:insert($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,<sp/>&lt;MESSAGE&gt;{concat(</highlight><highlight class="stringliteral">&quot;cannot<sp/>parse:<sp/>&quot;</highlight><highlight class="normal">,<sp/>$err:description)}&lt;/MESSAGE&gt;,<sp/>$x);}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>variable<sp/>$links<sp/>:=();</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(empty($content))</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>then<sp/>$links:=local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-out-links-unparsed($string-content,<sp/>fn:trace($x,<sp/></highlight><highlight class="stringliteral">&quot;parse<sp/>with<sp/>regex,<sp/>because<sp/>tidy<sp/>failed&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>$links:=local:</highlight><highlight class="keyword">get</highlight><highlight class="normal">-out-links-parsed($content,<sp/>$x);</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>$l<sp/>in<sp/>$links</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><sp/>local:process-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($l,<sp/>$x,<sp/>$n+1);</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">declare<sp/></highlight><highlight class="keyword">function</highlight><highlight class="normal"><sp/>local:print-results()<sp/><ref refid="namespacezorba_1_1locale_1_1iso639__1_1aafd6e55905dc8efe50a3f9fd38616781a1dea282b8d50cca16d5e6f8faef7d9d0" kindref="member" tooltip="Assamese.">as</ref><sp/>element()*</highlight></codeline>
<codeline><highlight class="normal">{</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>$x<sp/>in<sp/>map:keys($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links)/map:attribute/@value/string()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/>return<sp/>&lt;INTERNAL&gt;&lt;LINK&gt;{$x}&lt;/LINK&gt;{map:</highlight><highlight class="keyword">get</highlight><highlight class="normal">($local:processed-</highlight><highlight class="keyword">internal</highlight><highlight class="normal">-links,$x)}&lt;/INTERNAL&gt;,<sp/></highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>$x<sp/>in<sp/>map:keys($local:processed-external-links)/map:attribute/@value/string()</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/>return<sp/>&lt;EXTERNAL&gt;&lt;LINK&gt;{$x}&lt;/LINK&gt;{map:</highlight><highlight class="keyword">get</highlight><highlight class="normal">($local:processed-external-links,$x)}&lt;/EXTERNAL&gt;</highlight></codeline>
<codeline><highlight class="normal">};</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">(:==========================================</highlight></codeline>
<codeline><highlight class="normal">===========================================:)</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">variable<sp/>$uri:=<sp/>$top-uri;</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">variable<sp/>$result;</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">local:create-containers();</highlight></codeline>
<codeline><highlight class="normal">local:process-<ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22af20e9b610b976e6d27b9c105c39b9dd0" kindref="member">link</ref>($uri,<sp/></highlight><highlight class="stringliteral">&quot;&quot;</highlight><highlight class="normal">,<sp/>1);</highlight></codeline>
<codeline><highlight class="normal">$result:=local:print-results()<sp/>;</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal">local:</highlight><highlight class="keyword">delete</highlight><highlight class="normal">-containers();</highlight></codeline>
<codeline><highlight class="normal"></highlight></codeline>
<codeline><highlight class="normal"><ref refid="namespacezorba_1_1fs_1a33bc6a07dd3ac39c5107606fc21bea22ad51f6a8152afdfbcf0e0dd0d1c86cee0" kindref="member">file</ref>:write(fn:resolve-uri(</highlight><highlight class="stringliteral">&quot;link_crawler_result.xml&quot;</highlight><highlight class="normal">),</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;result&gt;{$result}&lt;/result&gt;,</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;output:serialization-parameters&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;output:indent<sp/>value=</highlight><highlight class="stringliteral">&quot;yes&quot;</highlight><highlight class="normal">/&gt;</highlight></codeline>
<codeline><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;/output:serialization-parameters&gt;)</highlight></codeline>
</programlisting> </para>    </detaileddescription>
  </compounddef>
</doxygen>
