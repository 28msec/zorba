machine:
  environment:
    ZORBA_SRC_DIR: /home/ubuntu/zorba
    ZORBA_BUILD_DIR: /home/ubuntu/build
    ZORBA_MODULE_DIR: /home/ubuntu/zorba_modules
    EXCLUDE_MODULES: "^zorba_info-extraction_module|conversion/currency-convert|zorba_couchbase_module|zorba_read-pdf_module|zorba_image_module|zorba_data-formatting_module"
  services:
    - docker
dependencies:
  override:
    - mkdir -p "${ZORBA_MODULE_DIR}"
    - cmake -Doutdir="${ZORBA_MODULE_DIR}" -Dallmodules=1 -P "${ZORBA_SRC_DIR}/modules/DownloadModules.cmake"
    - mkdir -p "${ZORBA_BUILD_DIR}"
test:
  pre:
    - case $CIRCLE_NODE_INDEX in 0) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-precise" "cmake" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-precise" "make" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-precise" "enable-extra-tests" ;; 1) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-trusty" "cmake" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-trusty" "make" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-trusty" "enable-extra-tests" ;;  2) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-vivid" "cmake" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-vivid" "make" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-vivid" "enable-extra-tests" ;;  3) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-wily" "cmake" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-wily" "make" && docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-wily" "enable-extra-tests" ;; esac:
      parallel: true
  override:
    - case $CIRCLE_NODE_INDEX in 0) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-precise" "ctest" "-E" "${EXCLUDE_MODULES}" ;; 1) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-trusty" "ctest" "-E" "${EXCLUDE_MODULES}" ;; 2) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-vivd" "ctest" "-E" "${EXCLUDE_MODULES}" ;; 3) docker run -v /home/ubuntu:/zorba "fcavalieri/zorba-test-wily" "ctest" "-E" "${EXCLUDE_MODULES}" ;; esac:
        parallel: true
        timeout: 600
