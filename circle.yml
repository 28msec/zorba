#This file is generated by https://github.com/wcandillon/zorba-circleci-tpl
machine:
  post:
    - sudo apt-get update -qq
#    - sudo apt-get install -f
    - sudo apt-get purge "libmagick*"
    - sudo apt-get purge "libboost*"
    - sudo apt-get purge "texlive*"
    - sudo apt-get install distcc python-pip lib64z1 lib64z1-dev uuid-dev libxerces-c-dev graphviz libboost-filesystem-dev libgeos++-dev imagemagick libmagick++-dev libmagickwand-dev libfop-java libpdfbox-java libtidy-dev libjempbox-java libfontbox-java libarchive-dev libmysqlclient-dev openjdk-6-jdk libaccess-bridge-java-jni libxslt-dev libcurl4-openssl-dev libxerces-c-dev doxygen libedit-dev libkvutils-dev
    - sudo locale-gen de_DE && sudo locale-gen de_DE.UTF-8 && sudo locale-gen fr_FR && sudo locale-gen fr_FR.UTF-8 && sudo update-locale
    - wget http://launchpadlibrarian.net/160037457/bison_3.0.2.dfsg-2_amd64.deb
    - wget http://launchpadlibrarian.net/160037458/libbison-dev_3.0.2.dfsg-2_amd64.deb
    - sudo dpkg -i libbison-dev_3.0.2.dfsg-2_amd64.deb bison_3.0.2.dfsg-2_amd64.deb
    - sudo sed -i.bak s/STARTDISTCC=\"false\"/STARTDISTCC=\"true\"/g /etc/default/distcc
    - sudo /etc/init.d/distcc start
#    - wget https://launchpad.net/ubuntu/+source/flex/2.5.39-8/+build/6118519/+files/libfl-dev_2.5.39-8_amd64.deb
#    - wget https://launchpad.net/ubuntu/+source/flex/2.5.39-8/+build/6118519/+files/flex_2.5.39-8_amd64.deb
#    - sudo dpkg -i libfl-dev_2.5.39-8_amd64.deb flex_2.5.39-8_amd64.deb
  environment:
    ZORBA_SRC_DIR: /home/ubuntu/zorba
    ZORBA_BUILD_DIR: /home/ubuntu/zorba/build
    ZORBA_MODULE_DIR: /home/ubuntu/zorba_modules
    DISTCC_HOSTS: "ubuntu@node0 ubuntu@node1 ubuntu@node2 ubuntu@node3 ubuntu@node4 ubuntu@node5 ubuntu@node6 ubuntu@node7"
dependencies:
  override:
    - echo "ZORBA_SRC_DIR ${ZORBA_SRC_DIR}"
    - echo "ZORBA_BUILD_DIR ${ZORBA_BUILD_DIR}"
    - echo "ZORBA_MODULE_DIR ${ZORBA_MODULE_DIR}"
    - mkdir -p "${ZORBA_MODULE_DIR}"
    - cmake -Doutdir="${ZORBA_MODULE_DIR}" -Dallmodules=1 -P "${ZORBA_SRC_DIR}/modules/DownloadModules.cmake"
    - mkdir -p "${ZORBA_BUILD_DIR}"
test:
  pre:
    - case $CIRCLE_NODE_INDEX in 0) cd "${ZORBA_BUILD_DIR}" && CC="distcc gcc" CXX="distcc c++" cmake -DZORBA_MODULES_DIR="${ZORBA_MODULE_DIR}" -DZORBA_SUPPRESS_SWIG=ON -DZORBA_XQUERYX:BOOL=1 -DZORBA_TEST_XQUERYX:BOOL=1 -DZORBA_WITH_BIG_INTEGER=1 -DCMAKE_BUILD_TYPE=Release -DZORBA_TEST_PLAN_SERIALIZATION:BOOL=1 -DZORBATEST_USE_MT_XQTS:BOOL=1 "${ZORBA_SRC_DIR}" && make -j16 && bash "${ZORBA_SRC_DIR}/import_tests.sh" && make fots-activate-sets && cd /home/ubuntu && tar -cf zorba.tar zorba ;; esac:
        parallel: true
    - case $CIRCLE_NODE_INDEX in 1) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; 2) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; 3) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; 4) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; 5) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; 6) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; 7) cd /home/ubuntu/ && scp -r ubuntu@node0:/home/ubuntu/zorba.tar . && tar -xvf zorba.tar ;; esac:
        parallel: true
  override:
    - case $CIRCLE_NODE_INDEX in 0) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 1,1000 -E ;; 1) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 1001,2000 -E ;; 2) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 2001,3000 -E ;; 3) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 3001,4000 -E ;; 4) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 4001,5000 -E ;; 5) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 5001,6000 -E ;; 6) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 6001,7000 -E ;; 7) cd "${ZORBA_BUILD_DIR}" && env QTTEST=42 QTTEST2=other QTTESTEMPTY='' ctest -j2 -T Test -I 7001 -E ;; esac:
        parallel: true
        timeout: 600

