MESSAGE(STATUS "les pre-cpack script")

IF(NOT EXISTS "@DEPENDS_EXE@")
	MESSAGE(FATAL_ERROR "@DEPENDS_EXE@ : Install Dependency Walker to detect the dll dependencies of zorba.exe. Then rerun cmake and point the DEPENDS_EXE var to the depends.exe .This program also comes packed with Visual Studio.")
ENDIF(NOT EXISTS "@DEPENDS_EXE@")

EXECUTE_PROCESS(COMMAND "@DEPENDS_EXE@" /c /oc:zorba_dependencies.csv "@ZORBA_EXE_PATH@")

FILE(STRINGS "@CMAKE_CURRENT_BINARY_DIR@/zorba_dependencies.csv" external_dlls)
FOREACH(external_dll ${external_dlls})
STRING(REGEX MATCH ",[^,]*," external_file_comma ${external_dll})
IF(NOT external_file_comma MATCHES "\\\\windows\\\\" AND 
	NOT external_file_comma MATCHES "[zZ][oO][rR][bB][aA][.][eE][xX][eE]" AND
	NOT external_file_comma MATCHES "[zZ][oO][rR][bB][aA][_][sS][iI][mM][pP][lL][eE][sS][tT][oO][rR][eE]" AND
	external_file_comma MATCHES ":\\\\")
STRING(LENGTH ${external_file_comma} external_file_comma_len)
MATH(EXPR external_file_comma_len ${external_file_comma_len}-2)
STRING(SUBSTRING ${external_file_comma} 1 ${external_file_comma_len} external_file)
MESSAGE(STATUS "${external_file}")
FILE(TO_NATIVE_PATH ${external_file} external_file)
#INSTALL(FILES ${external_file} DESTINATION bin)
FILE(COPY ${external_file} DESTINATION "@CMAKE_CURRENT_BINARY_DIR@/external_dlls")
ENDIF(NOT external_file_comma MATCHES "\\\\windows\\\\" AND 
			NOT external_file_comma MATCHES "[zZ][oO][rR][bB][aA][.][eE][xX][eE]" AND
			NOT external_file_comma MATCHES "[zZ][oO][rR][bB][aA][_][sS][iI][mM][pP][lL][eE][sS][tT][oO][rR][eE]" AND
			external_file_comma MATCHES ":\\\\")
ENDFOREACH(external_dll)
