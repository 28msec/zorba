# Copyright 2006-2008 The FLWOR Foundation.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

 rbkt :  a simple query testing tool
 -----------------------------------

 rbkt stands for "run bucket". The name comes from my IBM years...


 Pros and Cons
 -------------

  + Ready to use (no installation required; just checkout the rbkt directory
    under the test directory).

  + Grouping of queries into logical subset called "buckets". For example, a
    bucket called "paths" may contain queries testing path expressions.

  + Choice of running all queries in all buckets, all queries in a specific
    bucket, of a single query in a bucket.

  + Easy to add buckets and queries.

  + Can be used independently of Dan's test framework for quick testing
    during development, but is also integrated with the framework so that
    it will be run automatically during nightly builds, commits, etc.

  + Can be run from any directory.

  - Based os bash scripts, so not portable to Windows.


 Directory Structure
 -------------------


                       <zorbaRepos>
                            |
                           test
                            |
                           rbkt
                            |
       ---------------------------------------------------------
       |            |                         |                |
     Scripts      Queries              ExpQueryResults     QueryResults
       |            |                         |                |
     rbkt.sh        |                         |         ----------------   
   functions.sh     |                         |         |              |
                    |                         |      <bucket1> ... <bucketN>
                    |                         |         |              |
                    |                         |   { resultFiles } { resultFiles }
                    |                         |    { diffFiles }   { diffFiles }
                    |                         |
             --------------            ------------------
            |             |            |                |
        <bucket1>  ... <bucketN>    <bucket1>  ...   <bucketN>
            |             |            |                |
     { queryFiles } { queryFiles } { resultFiles } { resultFiles }


 - zorbaRepos is the root directory of a zorba repository
   (e.g., /home/markos/zorba/xquery/ )

 - rbkt.sh is the script that runs the tests (see operation and usage below)

 - The Queries directory contains the query files. Each query file contains
   one xquery. The query files are grouped in buckets, which are represented
   as subdirs of Queries.

 - Query file names must end with the .xq suffix.

 - The ExpQueryResults directory contains the expected results of each query.

 - Expected-result file names must be the same as the corresponding query
   file names, but with the .xq suffix replaced by the .res suffix. 

 - The QueryResults directory contains the actual query results generated by
   each invocation of rbkt.sh.

 - The QueryResults directory (and its subdirs) is generated automatically by
   rbkt.sh, if it doesn't exist already. QueryResults is NOT in svn.


 Operation
 ---------

 Let Q be a query contained in Queries/foo/q.xq (foo is the bucket name).
 If Q is run by rbkt.sh, then rbkt.sh creates a file Results/foo/q.res and
 compares it (via diff) with file  ExpQueryResults/foo/q.res. The result of
 this diff is writen to QueryResults/foo/q.diff.

 If QueryResults/foo/q.diff is not empty, rbkt.sh reports that Q has failed.

 If ExpQueryResults/foo/q.res does not exist, rbkt.sh prints a warning and
  reports that Q has failed.

 To create a new bucket, say foo, create a foo subdir under both Queries and
 ExpQueryResults.

 To add a new query, say Q, in bucket foo, add file q.xq under Queries/foo
 and q.res under ExpQueryResults/foo. 


 Usage
 -----

 This describes the usage of rbkt in the context of your local environment, and
 independently of Dan's framework (rbkt is also integrated with Dan's frameword,
 so if you run Dan's "integrate" script, rbkt.sh will be invoked and run all the
 buckets).

 1. Define the zorbaRepos env variable, setting it to the root dir of your local
    zorba repository. For example:

    $ export zorbaRepos=/home/markos/zorba/xquery

    Actually, I define zorbaRepos in my .bash_profile, so that I don't have to
    do it all the time.

 2. Define the zorbaExecDir env variable, setting it to the full pathname of the
    directory containing the apitest executable. For example:

    $ export zorbaExecDir=/home/markos/zorba/xquery/test/

    Actually, I define zorbaExecDir in my .bash_profile, so that I don't have to
    do it all the time.

 3. Run rbkt.sh in one of the following 3 ways

    $ ./rbkt.sh             // run all buckets 
    $ ./rbkt -b foo         // run bucket foo
    $ ./rbkt -b foo -q boo  // run query boo (stored in file boo.xq) in bucket foo

 4. The above assumes that you run rbkt.sh from rbkt/Scripts. But you can also
    run it from any other directory; you just have to specify the full pathname
    (relative or absolute) to rbkt.sh

    In fact, I have defined the following function in my .bash_profile:

    function rbkt()
    {
      ${zorbaRepos}/test/rbkt/Scripts/rbkt.sh "$@"
    }

    With this, I can run rbkt from any dir as if it were a linux command. E.g. 

    $ rbkt -b foo

 4. In addition to the query results and the diffs, rbkt.sh generates a file,
    called rbkt_summary.txt, which has one line per query run, saying if the
    query run was successful of not.

 5. If you add new queries, then you must run all the buckets and assuming all
    queries run successfully, copy the generated rbkt_summary.txt to
    test/zorbatest/testing/tests/test_results/acceptance/rbkt/result.txt

     
