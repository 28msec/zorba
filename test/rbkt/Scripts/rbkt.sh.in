# Copyright 2006-2008 The FLWOR Foundation.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#!/bin/bash

error=0

zorbaRepos=@zorbaRepos@
zorbaExecDir=@zorbaExecDir@

#
# The environment variable zorbaRepos must be defined. It should point to a
# directory containing a zorba source repository (e.g., /home/markos/zorba/xquery) 
#
if [ ! ${zorbaRepos} ]; then
   echo "ERROR 1 rbkt.sh: zorbaRepos environment variable is not set"
   exit 1
fi


#
# The environment variable zorbaExe must be defined. It must be set to the
# full pathname of the query_exec executable
#
if [ ! ${zorbaExecDir} ]; then
   echo "ERROR 1 rbkt.sh: zorbaExecDir environment variable is not set"
   exit 1
fi

#
# testRootDir is the root directory of the test environment. It contains the
# the scripts, the test queries and their expected results. It is also under
# this directory where all output from the tests is stored.
#
testRootDir="${zorbaRepos}/test/rbkt"

# The following dirs MUST exist under the testRootDir.
scriptsDir=${testRootDir}/Scripts

queriesDir=${testRootDir}/Queries
expQueryResultsDir=${testRootDir}/ExpQueryResults
docsDir=${testRootDir}/Documents
expLoaderResultsDir=${testRootDir}/ExpLoaderResults

# This is the dir where all query results are stored. This dir is created
# by the buildDirEnv function, if it does not exist already.
queryResultsDir=${testRootDir}/QueryResults

# This is the dir where all loader results are stored. This dir is created
# by the buildDirEnv function, if it does not exist already.
loaderResultsDir=${testRootDir}/LoaderResults


#
# sourcing of common functions
#
if [ ! -e ${scriptsDir}/functions.sh ]; then
   echo "ERROR 3 rbkt.sh: ${scriptsDir}/functions.sh does not exist"
   exit 3
fi

source ${scriptsDir}/functions.sh

trap '' 12

#
# Argument parsing
#
bucketList=""
bucketName=""
numBuckets=0
queryName=""
displayFormat="xml"

state=0
while [ $1 ]
do
   case $1 in
   -b) state=1;;

   -q) if [ $state -eq 0 -o $state -eq 1 -a $numBuckets -eq 1 ]; then
         state=2;
       else
         echo "ERROR 5 rbkt.sh: Wrong option -q"; usage; exit 5;
       fi ;;

   -d) state=3;;

   -h) usage ; exit;;

    *) case $state in

       1) if [ $numBuckets -eq 0 ]; then
            bucketList="$1"
          else
            bucketList="${bucketList} $1";
          fi 
          let numBuckets=$numBuckets+1 ;;

       2) queryName="$1"; state=0 ;;

       3) displayFormat="$1"; state=0 ;;

       *) echo "ERROR 6 rbkt.sh: Wrong parameter $1"; usage; exit 6;;
       esac ;;
    esac
    shift
done

if [ $numBuckets -eq 1 ]; then
  bucketName=$bucketList
fi

if [ $state -ne 0 -a $state -ne 1 ]; then
  echo "ERROR 7 rbkt.sh: Wrong arg list"; usage; exit 7;
fi

if [ ${displayFormat} != "xml" -a ${displayFormat} != "show" ]; then
  echo "ERROR 8 rbkt.sh: Wrong display format; must be xml or show"; exit 8;
fi

#
# Building env directories and runtime env
#
buildDirEnv
error=$?
if [ ${error} -ne 0 ]; then
  echo "ERROR 10 rbkt.sh: buildDirEnv function failed with error code ${error}"
  exit ${error}
fi


#
# Run queries
#
#echo; echo "Running Queries"
failedQueries=0
totalQueries=0

rm -f rbkt_summary.txt

if [ "${bucketName}" != "" ]; then

  if [ "${queryName}" != "" ]; then
    run_query_in_bucket "${bucketName}" "${queryName}" ${displayFormat}
    error=$?
    if [ ${error} -ne 0 ]; then
      echo "ERROR 70 rbkt.sh: run_query_in_bucket function failed with error code ${error}"
      exit ${error}
    fi
  else
    echo; echo "Running bucket ${bucketName}"
    run_bucket "${bucketName}" ${displayFormat}
    error=$?
    if [ ${error} -ne 0 ]; then
      echo "ERROR 71 rbkt.sh: run_bucket function failed with error code ${error}"
      exit ${error}
    fi
  fi

else
  if [ -z "${bucketList}" ]; then
    # bugfix by Matthias (collect the buckets automatically)
    bucketList=`find "${queriesDir}" -type d -maxdepth 1 ! -name '.svn' ! -name '.' ! -name 'Queries' -exec basename {} \;`
  fi

  echo "bucketList = $bucketList"

  for bucketName in ${bucketList}
  do
    echo; echo "Running bucket ${bucketName}"
    run_bucket "${bucketName}" ${displayFormat}
    error=$?
    if [ ${error} -ne 0 ]; then
      echo "ERROR 72 rbkt.sh: run_bucket function failed with error code ${error}"
      exit ${error}
    fi
  done
fi

echo
echo "rbkt.sh : total number of queries   = $totalQueries"
echo "rbkt.sh : number of failed queries  = $failedQueries"

echo >> rbkt_summary.txt
echo "rbkt.sh : number of failed queries  = $failedQueries" >> rbkt_summary.txt

rm -f query.dot
rm -f query.xml

if [ ${failedQueries} -gt 0 ]; then
  exit 1
else
   exit 0
fi
